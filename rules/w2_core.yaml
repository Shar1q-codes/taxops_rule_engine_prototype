- id: W2_SSN_FORMAT
  form_types: ["W2"]
  name: Taxpayer SSN format invalid
  severity: error
  description: "Taxpayer SSN is missing or not in ###-##-#### format (no masking)."
  condition:
    type: expression
    expr: "not is_valid_ssn(taxpayer_ssn)"
  references:
    - source: IRS W-2 Instructions
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["taxpayer.ssn"]

- id: W2_EIN_FORMAT
  form_types: ["W2"]
  name: Employer EIN format invalid
  severity: error
  description: "Employer EIN is missing or not in XX-XXXXXXX format with a valid prefix."
  condition:
    type: expression
    expr: "not is_valid_ein(employer_ein)"
  references:
    - source: IRS W-2 Instructions
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["employer.ein"]

- id: W2_WAGES_OVER_BASE_MISSING_SS_WAGES
  form_types: ["W2"]
  name: Social Security wages inconsistent with base
  severity: warning
  description: "Wages exceed the Social Security wage base but Social Security wages do not reach the cap."
  condition:
    type: expression
    expr: "wages > year_params.get('ss_wage_base', 0) and social_security_wages < min(wages, year_params.get('ss_wage_base', 0))"
  references:
    - source: IRS Pub. 15
      url: https://www.irs.gov/publications/p15
  fields: ["amounts.wages", "amounts.social_security_wages"]

- id: W2_SOCSEC_TAX_MATH
  form_types: ["W2"]
  name: Social Security tax does not match base x rate
  severity: error
  description: "Social Security tax {social_security_tax} should equal min(Social Security wages, wage base) x rate."
  condition:
    type: expression
    expr: "not within_tolerance(get('wages.social_security_tax_withheld', social_security_tax), min(get('wages.social_security_wages', social_security_wages or get('wages.wages_tips_other', wages)), year_params.get('ss_wage_base', 0)) * year_params.get('ss_rate', 0), year_params.get('tolerance', 1.0))"
  references:
    - source: IRS Pub. 15
      url: https://www.irs.gov/publications/p15
  fields: ["amounts.social_security_wages", "amounts.social_security_tax"]

- id: W2_MEDICARE_TAX_MATH
  form_types: ["W2"]
  name: Medicare tax does not match wages x rate
  severity: error
  description: "Medicare tax {medicare_tax} should equal Medicare wages x base rate plus Additional Medicare above the threshold."
  condition:
    type: expression
    expr: "not within_tolerance(get('wages.medicare_tax_withheld', medicare_tax), get('wages.medicare_wages', medicare_wages or get('wages.wages_tips_other', 0)) * year_params.get('medicare_rate', 0) + max(get('wages.medicare_wages', medicare_wages or get('wages.wages_tips_other', 0)) - year_params.get('medicare_threshold_s', 0), 0) * year_params.get('addl_medicare_rate', 0), year_params.get('tolerance', 1.0))"
  references:
    - source: IRS Pub. 15
      url: https://www.irs.gov/publications/p15
  fields: ["amounts.medicare_wages", "amounts.medicare_tax"]

- id: W2_STATE_WITHHOLDING_REQUIRES_STATE
  form_types: ["W2"]
  name: State withholding provided without state code
  severity: warning
  description: "State withholding is present but employer state is missing."
  condition:
    type: expression
    expr: "state_withholding > 0 and missing(employer_state)"
  references:
    - source: IRS W-2 State guidance
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["amounts.state_withholding", "employer.state"]

- id: W2_ZERO_FED_WITHHOLDING
  form_types: ["W2"]
  name: Zero federal withholding with significant wages
  severity: high
  description: "Federal withholding is zero while wages exceed $10,000."
  condition:
    type: expression
    expr: "wages > 10000 and federal_withholding <= 0"
  references:
    - source: IRS Withholding guidance
      url: https://www.irs.gov/businesses/small-businesses-self-employed/understanding-employer-withholding
  fields: ["amounts.wages", "amounts.federal_withholding"]

- id: W2_SOCSEC_WAGES_MISSING
  form_types: ["W2"]
  name: Social Security wages missing
  severity: warning
  description: "Social Security wages are blank while regular wages are present."
  condition:
    type: expression
    expr: "wages > 0 and social_security_wages <= 0"
  references:
    - source: IRS Pub. 15
      url: https://www.irs.gov/publications/p15
  fields: ["amounts.wages", "amounts.social_security_wages"]

- id: W2_MEDICARE_WAGES_MISSING
  form_types: ["W2"]
  name: Medicare wages missing
  severity: warning
  description: "Medicare wages are blank while regular wages are present."
  condition:
    type: expression
    expr: "wages > 0 and medicare_wages <= 0"
  references:
    - source: IRS Pub. 15
      url: https://www.irs.gov/publications/p15
  fields: ["amounts.wages", "amounts.medicare_wages"]

- id: W2_SOCSEC_WAGES_GT_WAGES
  form_types: ["W2"]
  name: Social Security wages exceed total wages
  severity: warning
  description: "Social Security wages exceed reported total wages, which is unlikely."
  condition:
    type: expression
    expr: "social_security_wages > wages + year_params.get('tolerance', 1.0)"
  references:
    - source: IRS Pub. 15
      url: https://www.irs.gov/publications/p15
  fields: ["amounts.wages", "amounts.social_security_wages"]

- id: W2_LOW_OCR_CONFIDENCE
  form_types: ["W2"]
  name: OCR confidence is low
  severity: info
  description: "OCR confidence below 0.8 may indicate extraction errors; double check numeric boxes."
  condition:
    type: expression
    expr: "ocr_quality < 0.8"
  references:
    - source: Internal QA
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["flags.ocr_quality"]

- id: W2_FIT_WITHHOLDING_REASONABLE
  form_types: ["W2"]
  name: Federal withholding appears unreasonably low
  severity: warning
  description: "Federal income tax withholding is under 5% of taxable wages despite wages above $20,000."
  condition:
    type: expression
    expr: "get('wages.wages_tips_other', 0) > 20000 and get('wages.federal_income_tax_withheld', 0) < get('wages.wages_tips_other', 0) * 0.05"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["wages.federal_income_tax_withheld", "wages.wages_tips_other"]

- id: W2_SS_TAX_MATCH
  form_types: ["W2"]
  name: Social Security tax does not align with wages
  severity: error
  description: "Social Security tax withheld should equal Social Security wages up to the wage base times the rate."
  condition:
    type: expression
    expr: "not within_tolerance(get('wages.social_security_tax_withheld', 0), min(get('wages.social_security_wages', get('wages.wages_tips_other', 0)), year_params.get('ss_wage_base', 0)) * year_params.get('ss_rate', 0), year_params.get('tolerance', 1.0))"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["wages.social_security_tax_withheld", "wages.social_security_wages"]

- id: W2_MEDICARE_TAX_MATCH
  form_types: ["W2"]
  name: Medicare tax does not align with wages
  severity: error
  description: "Medicare tax withheld should equal Medicare wages times the base rate plus Additional Medicare on wages above the threshold."
  condition:
    type: expression
    expr: "not within_tolerance(get('wages.medicare_tax_withheld', 0), get('wages.medicare_wages', 0) * year_params.get('medicare_rate', 0) + max(get('wages.medicare_wages', 0) - year_params.get('medicare_threshold_s', 0), 0) * year_params.get('addl_medicare_rate', 0), year_params.get('tolerance', 1.0))"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["wages.medicare_tax_withheld", "wages.medicare_wages"]

- id: W2_BOX1_VS_BOX3_5_RELATION
  form_types: ["W2"]
  name: Box 1 wages inconsistent with Boxes 3 and 5
  severity: warning
  description: "Box 1 wages differ materially from Social Security or Medicare wages; verify pre-tax deductions and coding."
  condition:
    type: expression
    expr: "get('wages.wages_tips_other', 0) > 0 and (abs(get('wages.wages_tips_other', 0) - get('wages.social_security_wages', 0)) > year_params.get('tolerance', 1.0) or abs(get('wages.wages_tips_other', 0) - get('wages.medicare_wages', 0)) > year_params.get('tolerance', 1.0))"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["wages.wages_tips_other", "wages.social_security_wages", "wages.medicare_wages"]

- id: W2_STATE_WAGE_TAX_VALID
  form_types: ["W2"]
  name: State wages and withholding inconsistent
  severity: warning
  description: "State tax withholding is non-zero but exceeds 15% of state wages or state wages are missing."
  condition:
    type: expression
    expr: "(get('state.state_tax_withheld', 0) > 0 and get('state.state_wages', 0) <= 0) or get('state.state_tax_withheld', 0) > get('state.state_wages', 0) * 0.15"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["state.state_wages", "state.state_tax_withheld"]

- id: W2_MULTI_W2_WAGE_BASE
  form_types: ["W2"]
  name: Social Security wages far below total wages
  severity: warning
  description: "Social Security wages are significantly lower than Box 1 wages; confirm multiple W-2s or missing wages."
  condition:
    type: expression
    expr: "get('wages.wages_tips_other', 0) > 0 and (get('wages.wages_tips_other', 0) - get('wages.social_security_wages', 0)) > year_params.get('ss_wage_base', 0) * 0.1"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["wages.wages_tips_other", "wages.social_security_wages"]

- id: W2_YEAR_CONSISTENCY
  form_types: ["W2"]
  name: Tax year outside supported range
  severity: error
  description: "Tax year on the document is not supported by configured parameters."
  condition:
    type: expression
    expr: "tax_year is None or tax_year not in supported_years"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["tax_year"]

- id: W2_EIN_VALID_CHECKSUM
  form_types: ["W2"]
  name: Employer EIN fails format validation
  severity: warning
  description: "Employer EIN fails checksum/format validation; verify against IRS-assigned EIN."
  condition:
    type: expression
    expr: "not ein_checksum_ok(employer_ein)"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["employer.ein"]

- id: W2_SS_WAGES_AT_OR_BELOW_BASE
  form_types: ["W2"]
  name: Social Security wages exceed wage base
  severity: error
  category: "MATH/CONSISTENCY"
  description: "Social Security wages should not exceed the year wage base; verify caps and reporting."
  condition:
    type: expression
    expr: "get('wages.social_security_wages', 0) > year_params.get('ss_wage_base', 0) + year_params.get('tolerance', 1.0)"
  references:
    - source: IRS SSA wage base
      url: https://www.ssa.gov
  fields: ["wages.social_security_wages"]

- id: W2_SS_TAX_MATCHES_RATE
  form_types: ["W2"]
  name: Social Security tax not aligned with wages
  severity: error
  category: "MATH/CONSISTENCY"
  description: "Social Security tax withheld should equal wages up to the wage base times the SS rate within tolerance."
  condition:
    type: expression
    expr: "not within_tolerance(get('wages.social_security_tax_withheld', 0), min(get('wages.social_security_wages', 0), year_params.get('ss_wage_base', 0)) * year_params.get('ss_rate', 0), year_params.get('tolerance', 1.0))"
  references:
    - source: IRS SSA wage base and rate
      url: https://www.ssa.gov
  fields: ["wages.social_security_tax_withheld", "wages.social_security_wages"]

- id: W2_MEDICARE_TAX_MATCHES_RATE
  form_types: ["W2"]
  name: Medicare tax not aligned with wages
  severity: error
  category: "MATH/CONSISTENCY"
  description: "Medicare tax withheld should equal Medicare wages times the rate plus any Additional Medicare above the threshold within tolerance."
  condition:
    type: expression
    expr: "not within_tolerance(get('wages.medicare_tax_withheld', 0), get('wages.medicare_wages', 0) * year_params.get('medicare_rate', 0) + max(get('wages.medicare_wages', 0) - year_params.get('medicare_threshold_s', 0), 0) * year_params.get('addl_medicare_rate', 0), year_params.get('tolerance', 1.0))"
  references:
    - source: Medicare withholding guidance
      url: https://www.irs.gov
  fields: ["wages.medicare_tax_withheld", "wages.medicare_wages"]

- id: W2_WAGE_BOX_RELATIONSHIP_SANITY
  form_types: ["W2"]
  name: Wage boxes relationship sanity check
  severity: warning
  category: "MATH/CONSISTENCY"
  description: "Box 1 should generally align with Boxes 3 and 5; flags large discrepancies or taxes with zero wages."
  condition:
    type: expression
    expr: "(get('wages.wages_tips_other', 0) > 0 and (get('wages.wages_tips_other', 0) > max(get('wages.social_security_wages', 0), get('wages.medicare_wages', 0)) * 1.1)) or ((get('wages.wages_tips_other', 0) + get('wages.social_security_wages', 0) + get('wages.medicare_wages', 0)) == 0 and (get('wages.social_security_tax_withheld', 0) > 0 or get('wages.medicare_tax_withheld', 0) > 0))"
  references:
    - source: W-2 wage boxes
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["wages.wages_tips_other", "wages.social_security_wages", "wages.medicare_wages"]

- id: W2_STATE_TAX_VS_WAGES_SANITY
  form_types: ["W2"]
  name: State tax reasonableness vs wages
  severity: warning
  category: "STATE/LOCAL"
  description: "State tax withheld should not exceed state wages or be excessively high relative to income."
  condition:
    type: expression
    expr: "get('state.state_tax_withheld', 0) > get('state.state_wages', 0) or get('state.state_tax_withheld', 0) > get('state.state_wages', 0) * 0.1 or get('state.state_tax_withheld', 0) > get('wages.wages_tips_other', 0) * 0.2"
  references:
    - source: State withholding guidance
      url: https://www.irs.gov
  fields: ["state.state_tax_withheld", "state.state_wages"]

- id: W2_STATE_WAGES_VS_BOX1_SANITY
  form_types: ["W2"]
  name: State wages vs Box 1 consistency
  severity: warning
  category: "STATE/LOCAL"
  description: "State wages should be reasonably close to Box 1 wages; flags large gaps that may indicate missing or duplicated wages."
  condition:
    type: expression
    expr: "abs(get('state.state_wages', 0) - get('wages.wages_tips_other', 0)) > max(year_params.get('tolerance', 1.0), get('wages.wages_tips_other', 0) * 0.2)"
  references:
    - source: W-2 state/local boxes
      url: https://www.irs.gov
  fields: ["state.state_wages", "wages.wages_tips_other"]

- id: W2_EMPLOYEE_SSN_REQUIRED
  form_types: ["W2"]
  name: Employee SSN missing
  severity: error
  category: "TIN/IDENTITY"
  description: "Employee SSN is required and cannot be blank."
  condition:
    type: expression
    expr: "missing(taxpayer_ssn)"
  references:
    - source: IRS W-2 Instructions
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["taxpayer.ssn"]

- id: W2_EMPLOYEE_SSN_FORMAT
  form_types: ["W2"]
  name: Employee SSN format invalid
  severity: error
  category: "TIN/IDENTITY"
  description: "Employee SSN must be 9 digits in ###-##-#### format."
  condition:
    type: expression
    expr: "not is_valid_ssn(taxpayer_ssn)"
  references:
    - source: IRS W-2 Instructions
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["taxpayer.ssn"]

- id: W2_EMPLOYEE_SSN_PLAUSIBILITY
  form_types: ["W2"]
  name: Employee SSN plausibility check
  severity: warning
  category: "TIN/IDENTITY"
  description: "Employee SSN appears to be a placeholder or repeated pattern; verify accuracy."
  condition:
    type: expression
    expr: "is_valid_ssn(taxpayer_ssn) and taxpayer_ssn in ['000-00-0000','111-11-1111','222-22-2222','333-33-3333','444-44-4444','555-55-5555','666-66-6666','777-77-7777','888-88-8888','999-99-9999','123-45-6789']"
  references:
    - source: IRS W-2 Instructions
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["taxpayer.ssn"]

- id: W2_EMPLOYER_EIN_REQUIRED
  form_types: ["W2"]
  name: Employer EIN missing
  severity: error
  category: "TIN/IDENTITY"
  description: "Employer EIN is required and cannot be blank."
  condition:
    type: expression
    expr: "missing(employer_ein)"
  references:
    - source: IRS W-2 Instructions
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["employer.ein"]

- id: W2_EMPLOYER_EIN_FORMAT
  form_types: ["W2"]
  name: Employer EIN format invalid
  severity: error
  category: "TIN/IDENTITY"
  description: "Employer EIN must be 9 digits in XX-XXXXXXX format."
  condition:
    type: expression
    expr: "not is_valid_ein(employer_ein)"
  references:
    - source: IRS W-2 Instructions
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["employer.ein"]

- id: W2_EMPLOYER_EIN_PLAUSIBILITY
  form_types: ["W2"]
  name: Employer EIN plausibility check
  severity: warning
  category: "TIN/IDENTITY"
  description: "Employer EIN appears to be a placeholder or repeated pattern; verify accuracy."
  condition:
    type: expression
    expr: "employer_ein in ['00-0000000','11-1111111','22-2222222','33-3333333','44-4444444','55-5555555','66-6666666','77-7777777','88-8888888','99-9999999']"
  references:
    - source: IRS W-2 Instructions
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["employer.ein"]

- id: W2_YEAR_SUPPORTED
  form_types: ["W2"]
  name: Tax year unsupported
  severity: error
  category: "YEAR/PARAMS"
  description: "Tax year is not in the configured year parameters."
  condition:
    type: expression
    expr: "tax_year is None or tax_year not in supported_years"
  references:
    - source: IRS General Instructions for Forms W-2 and W-3
      url: https://www.irs.gov/pub/irs-pdf/iw2w3.pdf
  fields: ["tax_year"]

- id: W2_SS_WAGE_BASE_RESPECTED
  form_types: ["W2"]
  name: SS wages exceed wage base
  severity: error
  category: "MATH/CONSISTENCY"
  description: "Social Security wages exceed the year wage base."
  condition:
    type: expression
    expr: "get('wages.social_security_wages', 0) > year_params.get('ss_wage_base', 0) + year_params.get('tolerance', 1.0)"
  references:
    - source: SSA wage base
      url: https://www.ssa.gov
  fields: ["wages.social_security_wages"]

- id: W2_SS_TAX_RATE_CONSISTENCY
  form_types: ["W2"]
  name: SS tax not aligned with wage base/rate
  severity: error
  category: "MATH/CONSISTENCY"
  description: "SS tax should equal wages up to the base times the SS rate within tolerance."
  condition:
    type: expression
    expr: "not within_tolerance(get('wages.social_security_tax_withheld', 0), min(get('wages.social_security_wages', 0), year_params.get('ss_wage_base', 0)) * year_params.get('ss_rate', 0), year_params.get('tolerance', 1.0))"
  references:
    - source: SSA wage base and rate
      url: https://www.ssa.gov
  fields: ["wages.social_security_tax_withheld", "wages.social_security_wages"]

- id: W2_MEDICARE_TAX_RATE_CONSISTENCY
  form_types: ["W2"]
  name: Medicare tax not aligned with rate/threshold
  severity: error
  category: "MATH/CONSISTENCY"
  description: "Medicare tax should equal Medicare wages times the rate plus any Additional Medicare above the threshold within tolerance."
  condition:
    type: expression
    expr: "not within_tolerance(get('wages.medicare_tax_withheld', 0), get('wages.medicare_wages', 0) * year_params.get('medicare_rate', 0) + max(get('wages.medicare_wages', 0) - year_params.get('medicare_threshold_s', 0), 0) * year_params.get('addl_medicare_rate', 0), year_params.get('tolerance', 1.0))"
  references:
    - source: Medicare withholding
      url: https://www.irs.gov
  fields: ["wages.medicare_tax_withheld", "wages.medicare_wages"]

- id: W2_FICA_ZERO_WITH_WAGES
  form_types: ["W2"]
  name: FICA zero while wages reported
  severity: warning
  category: "MATH/CONSISTENCY"
  description: "Social Security or Medicare wages are present but corresponding tax withheld is zero."
  condition:
    type: expression
    expr: "(get('wages.social_security_wages', 0) > 0 and get('wages.social_security_tax_withheld', 0) <= 0) or (get('wages.medicare_wages', 0) > 0 and get('wages.medicare_tax_withheld', 0) <= 0)"
  references:
    - source: FICA withholding
      url: https://www.irs.gov
  fields: ["wages.social_security_wages", "wages.social_security_tax_withheld", "wages.medicare_wages", "wages.medicare_tax_withheld"]

- id: W2_WAGES_NONNEGATIVE
  form_types: ["W2"]
  name: Wages cannot be negative
  severity: error
  category: "MATH/CONSISTENCY"
  description: "Wage fields (Boxes 1, 3, 5, state wages) must be zero or positive."
  condition:
    type: expression
    expr: "min([get('wages.wages_tips_other', 0), get('wages.social_security_wages', 0), get('wages.medicare_wages', 0), get('state.state_wages', 0)]) < 0"
  references:
    - source: W-2 wage boxes
      url: https://www.irs.gov
  fields: ["wages.wages_tips_other", "wages.social_security_wages", "wages.medicare_wages", "state.state_wages"]

- id: W2_TAX_WITHHELD_NONNEGATIVE
  form_types: ["W2"]
  name: Taxes cannot be negative
  severity: error
  category: "MATH/CONSISTENCY"
  description: "Federal and FICA/state tax withheld fields must be zero or positive."
  condition:
    type: expression
    expr: "min([get('wages.federal_income_tax_withheld', 0), get('wages.social_security_tax_withheld', 0), get('wages.medicare_tax_withheld', 0), get('state.state_tax_withheld', 0)]) < 0"
  references:
    - source: W-2 tax boxes
      url: https://www.irs.gov
  fields: ["wages.federal_income_tax_withheld", "wages.social_security_tax_withheld", "wages.medicare_tax_withheld", "state.state_tax_withheld"]

- id: W2_FED_WITHHOLDING_REASONABLE
  form_types: ["W2"]
  name: Federal withholding ratio out of range
  severity: warning
  category: "WITHHOLDING"
  description: "Federal withholding appears unusually low or high relative to Box 1 wages."
  condition:
    type: expression
    expr: "get('wages.wages_tips_other', 0) > 0 and (get('wages.federal_income_tax_withheld', 0) < 0 or get('wages.federal_income_tax_withheld', 0) / get('wages.wages_tips_other', 0) < 0.0 or get('wages.federal_income_tax_withheld', 0) / get('wages.wages_tips_other', 0) > 0.5)"
  references:
    - source: FIT withholding guidance
      url: https://www.irs.gov
  fields: ["wages.federal_income_tax_withheld", "wages.wages_tips_other"]

- id: W2_DEPENDENT_CARE_BOX10_NONNEGATIVE
  form_types: ["W2"]
  name: Dependent care benefits cannot be negative
  severity: error
  category: "MATH/CONSISTENCY"
  description: "Dependent care benefits (Box 10) must be zero or positive."
  condition:
    type: expression
    expr: "get('wages.dependent_care_benefits', get('wages.box10_dependent_care', 0)) < 0"
  references:
    - source: W-2 Box 10
      url: https://www.irs.gov/forms-pubs/about-form-w-2
  fields: ["wages.dependent_care_benefits"]

- id: W2_RETIREMENT_AND_DEFERRAL_FLAGS
  form_types: ["W2"]
  name: Retirement/deferral flags missing
  severity: warning
  category: "STRUCTURE"
  description: "Pre-tax deferrals or retirement contributions reported without a retirement indicator; verify coding."
  condition:
    type: expression
    expr: "get('wages.retirement_contributions', get('wages.box12_deferrals', 0)) > 0 and not get('flags.retirement_plan', False)"
  references:
    - source: W-2 retirement indicators
      url: https://www.irs.gov
  fields: ["wages.retirement_contributions", "flags.retirement_plan"]

- id: W2_STATE_WAGES_NONNEGATIVE
  form_types: ["W2"]
  name: State wages cannot be negative
  severity: error
  category: "STATE/LOCAL"
  description: "State wage amounts must be zero or positive."
  condition:
    type: expression
    expr: "get('state.state_wages', 0) < 0"
  references:
    - source: W-2 state/local boxes
      url: https://www.irs.gov
  fields: ["state.state_wages"]

- id: W2_STATE_TAX_NONNEGATIVE
  form_types: ["W2"]
  name: State tax cannot be negative
  severity: error
  category: "STATE/LOCAL"
  description: "State tax withheld must be zero or positive."
  condition:
    type: expression
    expr: "get('state.state_tax_withheld', 0) < 0"
  references:
    - source: W-2 state/local boxes
      url: https://www.irs.gov
  fields: ["state.state_tax_withheld"]

- id: W2_STATE_CODE_FORMAT
  form_types: ["W2"]
  name: State code format invalid
  severity: warning
  category: "STATE/LOCAL"
  description: "State code is missing or not a valid two-character code while state wages/tax are reported."
  condition:
    type: expression
    expr: "(get('state.state_wages', 0) > 0 or get('state.state_tax_withheld', 0) > 0) and (missing(get('state.state_code', '')) or len(str(get('state.state_code', '')).strip()) != 2)"
  references:
    - source: W-2 state/local boxes
      url: https://www.irs.gov
  fields: ["state.state_code"]

- id: W2_STATE_WAGES_VS_BOX1
  form_types: ["W2"]
  name: State wages vs Box 1 alignment
  severity: warning
  category: "STATE/LOCAL"
  description: "Sum of state wages should align reasonably with Box 1 wages; flags large deviations."
  condition:
    type: expression
    expr: "abs(get('state.state_wages', 0) - get('wages.wages_tips_other', 0)) > max(year_params.get('tolerance', 1.0), get('wages.wages_tips_other', 0) * 0.2)"
  references:
    - source: W-2 state/local boxes
      url: https://www.irs.gov
  fields: ["state.state_wages", "wages.wages_tips_other"]

- id: W2_REQUIRED_EMPLOYEE_INFO
  form_types: ["W2"]
  name: Employee info missing
  severity: error
  category: "STRUCTURE"
  description: "Employee name or address information is missing."
  condition:
    type: expression
    expr: "missing(get('employee.first_name', get('taxpayer.first_name', ''))) or missing(get('employee.last_name', get('taxpayer.last_name', '')))"
  references:
    - source: W-2 required fields
      url: https://www.irs.gov
  fields: ["employee.first_name", "employee.last_name"]

- id: W2_REQUIRED_EMPLOYER_INFO
  form_types: ["W2"]
  name: Employer info missing
  severity: error
  category: "STRUCTURE"
  description: "Employer name or address information is missing."
  condition:
    type: expression
    expr: "missing(get('employer.name', ''))"
  references:
    - source: W-2 required fields
      url: https://www.irs.gov
  fields: ["employer.name"]

- id: W2_ZERO_DOCUMENT_SANITY
  form_types: ["W2"]
  name: All wages and taxes zero
  severity: warning
  category: "STRUCTURE"
  description: "All wage and tax fields are zero; likely placeholder or extraction failure."
  condition:
    type: expression
    expr: "(get('wages.wages_tips_other', 0) + get('wages.social_security_wages', 0) + get('wages.medicare_wages', 0) + get('wages.federal_income_tax_withheld', 0) + get('wages.social_security_tax_withheld', 0) + get('wages.medicare_tax_withheld', 0) + get('state.state_wages', 0) + get('state.state_tax_withheld', 0)) == 0"
  references:
    - source: W-2 required reporting
      url: https://www.irs.gov
  fields: ["wages", "state"]

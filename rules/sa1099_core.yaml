- id: SA1099_PAYER_TIN_REQUIRED
  form_types: ["1099-SA"]
  name: Payer TIN missing
  severity: error
  category: "TIN/IDENTITY"
  description: "Payer TIN must be present."
  condition:
    type: expression
    expr: "missing(get('payer.tin', ''))"
  references:
    - source: IRS 1099-SA Instructions
  fields: ["payer.tin"]

- id: SA1099_RECIPIENT_TIN_REQUIRED
  form_types: ["1099-SA"]
  name: Recipient TIN missing
  severity: error
  category: "TIN/IDENTITY"
  description: "Recipient TIN must be present."
  condition:
    type: expression
    expr: "missing(get('recipient.tin', ''))"
  references:
    - source: IRS 1099-SA Instructions
  fields: ["recipient.tin"]

- id: SA1099_TAX_YEAR_REASONABLE
  form_types: ["1099-SA"]
  name: Tax year out of range
  severity: error
  category: "STRUCTURE"
  description: "Tax year must be between 2018 and a reasonable future year."
  condition:
    type: expression
    expr: "tax_year is None or tax_year < 2018 or tax_year > (2030 if not supported_years else max(supported_years) + 1)"
  references:
    - source: IRS 1099-SA Instructions
  fields: ["tax_year"]

- id: SA1099_NONNEGATIVE_AMOUNTS
  form_types: ["1099-SA"]
  name: Amounts cannot be negative
  severity: error
  category: "AMOUNTS/CONSISTENCY"
  description: "Gross distribution, earnings on excess contributions, withholding, FMV, and state amounts must be zero or positive."
  condition:
    type: expression
    expr: "min([get_amount(k, 0) for k in ['box1_gross_distribution','box2_earnings_on_excess_contributions','box4_federal_income_tax_withheld','box5_fair_market_value_hsa_msa']] + [min([v for v in get('state_tax_withheld', []) if v is not None] or [0]), min([v for v in get('state_income', []) if v is not None] or [0])]) < 0"
  references:
    - source: IRS 1099-SA Instructions
  fields:
    - "amounts.box1_gross_distribution"

- id: SA1099_WITHHELD_NOT_EXCESSIVE
  form_types: ["1099-SA"]
  name: Withholding disproportionately high
  severity: warning
  category: "WITHHOLDING"
  description: "Federal withholding should not exceed 50% of gross distribution."
  condition:
    type: expression
    expr: "get_amount('box1_gross_distribution', 0) > 0 and get_amount('box4_federal_income_tax_withheld', 0) > get_amount('box1_gross_distribution', 0) * 0.5"
  references:
    - source: IRS 1099-SA Instructions
  fields:
    - "amounts.box4_federal_income_tax_withheld"

- id: SA1099_ONE_ACCOUNT_TYPE_FLAG
  form_types: ["1099-SA"]
  name: Account type flags inconsistent
  severity: warning
  category: "STRUCTURE"
  description: "Exactly one of HSA, Archer MSA, or MA MSA should be selected."
  condition:
    type: expression
    expr: "(int(bool(get('hsa', False))) + int(bool(get('archer_msa', False))) + int(bool(get('ma_msa', False)))) != 1"
  references:
    - source: IRS 1099-SA Instructions
  fields:
    - "hsa"

- id: SA1099_DISTRIBUTION_CODE_REQUIRED_WITH_DISTRIBUTION
  form_types: ["1099-SA"]
  name: Distribution code missing
  severity: error
  category: "STRUCTURE"
  description: "If a distribution is reported, the distribution code should be present."
  condition:
    type: expression
    expr: "get_amount('box1_gross_distribution', 0) > 0 and missing(get('box3_distribution_code', ''))"
  references:
    - source: IRS 1099-SA Instructions
  fields:
    - "box3_distribution_code"

- id: SA1099_STATE_LIST_LENGTHS_MATCH
  form_types: ["1099-SA"]
  name: State fields length mismatch
  severity: warning
  category: "STATE/LOCAL"
  description: "State withheld, state IDs, and state income lists should align in length."
  condition:
    type: expression
    expr: "(len(get('state_tax_withheld', [])) not in (0, len(get('state_id', [])), len(get('state_income', [])))) or (len(get('state_id', [])) not in (0, len(get('state_tax_withheld', [])), len(get('state_income', [])))) or (len(get('state_income', [])) not in (0, len(get('state_tax_withheld', [])), len(get('state_id', []))))"
  references:
    - source: IRS 1099-SA Instructions
  fields:
    - "state_tax_withheld"
